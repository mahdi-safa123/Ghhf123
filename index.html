<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>نظام تحويل الدولار إلى دينار مع القاصة وسجل التدقيق</title>
  <style>
    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      max-width: 480px;
      margin: 30px auto;
      background: #f4f7f6;
      color: #222;
      padding: 15px;
      box-shadow: 0 0 10px #ccc;
      border-radius: 8px;
    }
    h1 {
      text-align: center;
      margin-bottom: 25px;
      color: #2a6f9e;
    }
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      font-size: 1.1em;
    }
    input[type="number"] {
      width: 100%;
      font-size: 1.2em;
      padding: 8px;
      border-radius: 5px;
      border: 1px solid #aaa;
      box-sizing: border-box;
      margin-bottom: 15px;
    }
    button {
      width: 100%;
      padding: 12px;
      font-size: 1.2em;
      background-color: #2a6f9e;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.25s;
      margin-bottom: 12px;
    }
    button:hover {
      background-color: #224f6a;
    }
    .cashbox {
      margin: 20px 0;
      padding: 20px;
      background: #d9f0f7;
      border-radius: 10px;
      text-align: center;
      font-size: 1.4em;
      font-weight: bold;
      color: #13506d;
      box-shadow: inset 0 0 8px #9dd1e4;
    }
    .log-section {
      margin-top: 30px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      box-shadow: 0 0 6px #aaa;
      border-radius: 8px;
      overflow: hidden;
    }
    th, td {
      padding: 10px 8px;
      text-align: center;
      border-bottom: 1px solid #eee;
      font-size: 0.95em;
    }
    th {
      background-color: #2a6f9e;
      color: white;
    }
    tr:last-child td {
      border-bottom: none;
    }
    .empty-log {
      text-align: center;
      margin-top: 10px;
      font-style: italic;
      color: #666;
    }
  </style>
</head>
<body>

  <h1>محول دولار إلى دينار مع القاصة وسجل التدقيق</h1>

  <label for="usdInput">أدخل قيمة الدولار:</label>
  <input type="number" id="usdInput" min="0" step="0.01" placeholder="مثال: 10" />
  <button id="convertBtn">تحويل وخصم من القاصة</button>

  <label for="addAmountInput">أدخل مبلغ دينار لإضافته إلى القاصة:</label>
  <input type="number" id="addAmountInput" min="0" step="1" placeholder="مثال: 5000" />
  <button id="addCashBtn">إضافة إلى القاصة</button>

  <button id="exportLogBtn" style="background:#4caf50;">تصدير سجل التدقيق (CSV)</button>

  <div class="cashbox" id="cashbox">
    رصيد القاصة: <span id="cashAmount">0</span> دينار
  </div>

  <div class="log-section">
    <h2>سجل التدقيق</h2>
    <table id="logTable" aria-label="سجل العمليات">
      <thead>
        <tr>
          <th>التاريخ والوقت</th>
          <th>الدولار</th>
          <th>الدينار</th>
          <th>الرصيد بعد العملية</th>
        </tr>
      </thead>
      <tbody id="logBody">
        <tr><td colspan="4" class="empty-log">لا توجد عمليات حتى الآن</td></tr>
      </tbody>
    </table>
  </div>

<script>
  const RATE = 1320;
  const cashboxEl = document.getElementById("cashAmount");
  const logBody = document.getElementById("logBody");
  const usdInput = document.getElementById("usdInput");
  const convertBtn = document.getElementById("convertBtn");
  const addAmountInput = document.getElementById("addAmountInput");
  const addCashBtn = document.getElementById("addCashBtn");
  const exportLogBtn = document.getElementById("exportLogBtn");

  let cash = Number(localStorage.getItem("cashbox")) || 0;
  let logs = JSON.parse(localStorage.getItem("logs")) || [];

  function formatDate(d) {
    return d.toLocaleString("ar-EG", {
      year: "numeric",
      month: "2-digit",
      day: "2-digit",
      hour: "2-digit",
      minute: "2-digit",
      second: "2-digit",
      hour12: false,
    });
  }

  function updateCashbox() {
    cashboxEl.textContent = cash.toLocaleString("ar-EG");
  }

  function renderLogs() {
    logBody.innerHTML = "";
    if (logs.length === 0) {
      logBody.innerHTML = `<tr><td colspan="4" class="empty-log">لا توجد عمليات حتى الآن</td></tr>`;
      return;
    }
    logs.forEach(log => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${log.date}</td>
        <td>${log.usd.toLocaleString("ar-EG", {minimumFractionDigits:2})}</td>
        <td>${log.iqd.toLocaleString("ar-EG")}</td>
        <td>${log.balance.toLocaleString("ar-EG")}</td>
      `;
      logBody.appendChild(tr);
    });
  }

  function saveData() {
    localStorage.setItem("cashbox", cash);
    localStorage.setItem("logs", JSON.stringify(logs));
  }

  function addOperation(usdAmount) {
    const iqdAmount = Math.round(usdAmount * RATE);
    cash -= iqdAmount;
    if (cash < 0) cash = 0;
    const now = new Date();
    const logEntry = {
      date: formatDate(now),
      usd: usdAmount,
      iqd: iqdAmount,
      balance: cash,
    };
    logs.unshift(logEntry);
    saveData();
    updateCashbox();
    renderLogs();
  }

  function addCash(iqdAmount) {
    cash += iqdAmount;
    const now = new Date();
    const logEntry = {
      date: formatDate(now),
      usd: 0,
      iqd: iqdAmount,
      balance: cash,
    };
    logs.unshift(logEntry);
    saveData();
    updateCashbox();
    renderLogs();
  }

  function exportCSV() {
    if (logs.length === 0) {
      alert("لا توجد بيانات لتصديرها.");
      return;
    }
    let csvContent = "data:text/csv;charset=utf-8,";
    csvContent += "التاريخ والوقت,الدولار,الدينار,الرصيد بعد العملية\n";
    logs.slice().reverse().forEach(log => {
      const row = `${log.date},${log.usd},${log.iqd},${log.balance}\n`;
      csvContent += row;
    });

    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "log_records.csv");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }

  updateCashbox();
  renderLogs();

  convertBtn.addEventListener("click", () => {
    const usdVal = parseFloat(usdInput.value);
    if (isNaN(usdVal) || usdVal <= 0) {
      alert("يرجى إدخال قيمة دولار صحيحة أكبر من صفر");
      usdInput.focus();
      return;
    }
    if (cash === 0) {
      alert("الرصيد في القاصة صفر، الرجاء إضافة مبلغ أولاً");
      usdInput.value = "";
      usdInput.focus();
      return;
    }
    addOperation(usdVal);
    usdInput.value = "";
    usdInput.focus();
  });

  addCashBtn.addEventListener("click", () => {
    const iqdVal = parseInt(addAmountInput.value);
    if (isNaN(iqdVal) || iqdVal <= 0) {
      alert("يرجى إدخال مبلغ دينار صحيح أكبر من صفر");
      addAmountInput.focus();
      return;
    }
    addCash(iqdVal);
    addAmountInput.value = "";
    addAmountInput.focus();
  });

  exportLogBtn.addEventListener("click", () => {
    exportCSV();
  });
</script>

</body>
</html>
